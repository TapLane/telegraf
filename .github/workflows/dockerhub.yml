name: Build & Push Telegraf Image (master)

on:
  push:
    branches: ["master"]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-push:
    # Avoid infinite loop when we commit back BuildVersion with [skip ci]
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Bump BuildVersion
        id: version
        shell: bash
        run: |
          CURRENT="$(cat BuildVersion 2>/dev/null || echo "0.0.0")"
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"
          PATCH="${PATCH:-0}"
          NEW_PATCH=$((PATCH + 1))
          TAG="${MAJOR}.${MINOR}.${NEW_PATCH}"

          echo "$TAG" > BuildVersion
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Commit BuildVersion + Git tag
        shell: bash
        run: |
          TAG="${{ steps.version.outputs.tag }}"

          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config user.name  "github-actions[bot]"

          git add BuildVersion
          git commit -m "chore([skip ci]): bump BuildVersion to $TAG" || echo "No changes to commit"

          git tag -f "$TAG" || true
          git push origin HEAD:master --tags --force

      - name: Log in to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push Docker Image
        shell: bash
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          IMAGE="${{ vars.DOCKER_URL }}/${{ vars.REPO_NAME }}:$TAG"
          LATEST="${{ vars.DOCKER_URL }}/${{ vars.REPO_NAME }}:latest"

          echo "Building $IMAGE"
          docker build -t "$IMAGE" -t "$LATEST" .

          echo "Pushing $IMAGE"
          docker push "$IMAGE"
          docker push "$LATEST"
